---
title: "Recruit Timeline"
output: html_document
date: "2025-10-09"
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
library(data.table)

ntb = fread("Datasets In Progress/ntb_v3.csv")
tb = fread("Datasets In Progress/tb_v4.csv")
all <- rbind(tb,ntb)


remove_blank <- function(x){
  x <- x |>
    mutate(across(everything(), ~if_else(.x == "", NA, .x)))
  return(x)
}

cln_dupl <- function(x){
  x[duplicated(x)] <- NA
  return(x)
}


```

## R Markdown

To help me visualize the timeline of these recruits, I've found a couple of examples

```{r rec1}

tline <- all |>
  select(recidnum,
         
    rb_date1,
    
    lstdt1_1, lstdt1_2, lstdt1_3,
    lstdt2_1, lstdt2_2, lstdt2_3,
    
    dschdt01, dschdt02, dschdt03, dschdt04, dschdt05,
    dschdt06, dschdt07, dschdt08, dschdt09, dschdt10,
    dschdt11, dschdt12, dschdt13, dschdt14, dschdt15,
    dschdt16, dschdt17, dschdt18, dschdt19, dschdt20,
    dchdt1_1, dchdt1_2, dchdt1_3, dchdt2_1, dchdt2_2, dchdt2_3, 
    
illwnd01, illwnd02, illwnd03, illwnd04, illwnd05, illwnd06, illwnd07, illwnd08, illwnd09, illwnd10, illwnd11, illwnd12, illwnd13, illwnd14, illwnd15, illwnd16, illwnd17, illwnd18, illwnd19, illwnd20, admtdt01, admtdt02, admtdt03, admtdt04, admtdt05, admtdt06, admtdt07, admtdt08, admtdt09, admtdt10, admtdt11, admtdt12, admtdt13, admtdt14, admtdt15, admtdt16, admtdt17, admtdt18, admtdt19, admtdt20, relsdt01, relsdt02, relsdt03, relsdt04, relsdt05, relsdt06, relsdt07, relsdt08, relsdt09, relsdt10, relsdt11, relsdt12, relsdt13, relsdt14, relsdt15, relsdt16, relsdt17, relsdt18, relsdt19, relsdt20,
    
dsrtdt01, dsrtdt02, dsrtdt03, dsrtdt04, dsrtdt05, dsrtdt06, dsrtdt07, dsrtdt08, dsrtdt09, dsrtdt10, dsrtdt11, dsrtdt12, dsrtdt13, dsrtdt14, dsrtdt15, dsrtdt16, dsrtdt17, dsrtdt18, dsrtdt19, dsrtdt20, 

rd_date
  )

#####
rec1 <- t(tline[8,])
dt1 <- rec1[,1]
rec1 <- data.frame(rec1[dt1 !='' & !is.na(dt1), ,drop = F])


##### Desertion w TB
rec2 <- t(tline[124,])
dt2 <- rec2[,1]
rec2 <- data.frame(rec2[dt2 !='' & !is.na(dt2), ,drop = F])

check <- t(all[124,])
tb_birth[124,]

#####
rec3a <- tline[2866,]
dt3a <- rec3a[[1]]
rec3a <- data.frame(rec3a[dt3a !='' & !is.na(dt3a), ,drop = F])
t(rec3a)

#####
rec3b <- tline[2869,]
dt3b <- rec3b[[1]]
rec3b <- data.frame(rec3b[dt3b !='' & !is.na(dt3b), ,drop = F])
t(rec3b)

tb_birth[2869,]

```

## Timeline Organizations

For the recruits, I would like to know the total time spent in hospitals and the number of hospital visits, as well as the number of enlistments and the total time spent in the military. let's start with enlistments:

```{r lst}

##########  Step 1: Finalizing enlistment dates  ##########

# Isolate all enlistments

lst <- all |>
  select(recidnum,
    lstdt1_1, mildfdt1, lstdt1_2, mildfdt2,
    lstdt1_3, mildfdt3, lstdt2_1, mildfdt4,
    lstdt2_2, mildfdt5, lstdt2_3, mildfdt6
  )

### Turn all blanks into NA and remove repeated dates

is.data.frame(lst)


remove_blank <- function(x){
  x <- x |>
    mutate(across(everything(), ~if_else(.x == "", NA, .x)))
  return(x)
}

cln_dupl <- function(x){
  x[duplicated(x)] <- NA
  return(x)
}

lst <- as.data.frame(t(apply(remove_blank(lst), 1, cln_dupl)))



### Cleaning approximate dates (for day, use 15; for month)


# Find all rows with "--"

lst_dash <- all |>
  select(lstdt1_1, lstdt1_2, lstdt1_3,
         lstdt2_1, lstdt2_2, lstdt2_3) |>
  filter(
    if_any(lstdt1_1:lstdt2_3, ~grepl("--", .))
  )


# Turn end "--" into 0 and delete every cell that still has "--" to get rid of dates that are too arbitrary (month or year is unknown)

lst <- lst |>
  select(lstdt1_1, mildfdt1, lstdt1_2, mildfdt2,
         lstdt1_3, mildfdt3, lstdt2_1, mildfdt4,
         lstdt2_2, mildfdt5, lstdt2_3, mildfdt6
  ) |>
  mutate(
    (across(everything(), ~gsub("--$", "00", .)))
  ) |>
  mutate(
    across(everything(), ~if_else(grepl("--", .x), NA, .x))
  )



###########  Step 2: Finalizing Discharge dates   ##########


### What else can stand in for discharge?
#     Desertion, Death, Capture POW
#     NOT AWOL
#     NOT Furlough (temporary leave of absence)

### We must make another dataframe with all of the alternatives for exiting service (we only care about the designations with dates)

rexit <- all |>
  select(recidnum,
    milcact1, milcact2, milcact3, milcact4, milcact5,
    milcrsn1, milcrsn2, milcrsn3, milcrsn4, milcrsn5,
    milctdt1, milctdt2, milctdt3, milctdt4, milctdt5,
    
    dsrtdt01, dsrtdt02, dsrtdt03, dsrtdt04, dsrtdt05,
    dsrtdt06, dsrtdt07, dsrtdt08, dsrtdt09, dsrtdt10,
    dsrtdt11, dsrtdt12, dsrtdt13, dsrtdt14, dsrtdt15, 
    dsrtdt16, dsrtdt17, dsrtdt18, dsrtdt19, dsrtdt20
  )

rexit <- remove_blank(rexit)

milc1 <- rexit |>
  select(recidnum, milcact1, milcrsn1, milctdt1)
milc2 <- rexit |>
  select(recidnum, milcact2, milcrsn2, milctdt2)
milc3 <- rexit |>
  select(recidnum, milcact3, milcrsn3, milctdt3)
milc4 <- rexit |>
  select(recidnum, milcact4, milcrsn4, milctdt4)
milc5 <- rexit |>
  select(recidnum, milcact5, milcrsn5, milctdt5)


# filter for identifying desertion, removing "--"

milc_dsrt_filter <- function(x){
  as.character(
    case_when(
      grepl('desert', x[[3]], ignore.case = T) | x[[2]] == "D" ~ x[[4]],
      T ~ NA_character_
    )
  )
}

milc_dsrt <- tibble(dsrt1 = as.character(milc_dsrt_filter(milc1)),
                   dsrt2 = as.character(milc_dsrt_filter(milc2)),
                   dsrt3 = as.character(milc_dsrt_filter(milc3)),
                   dsrt4 = as.character(milc_dsrt_filter(milc4)),
                   dsrt5 = as.character(milc_dsrt_filter(milc5)))

milc_dsrt <- bind_cols(
  milc_dsrt,
  rexit |> select(starts_with("dsrtdt"))
)


cln_31 <- function(x){
  x <- x |>
  mutate(
    across(
      everything(),
      ~ {
        x <- gsub("--$", "31", .x)           
        x <- ifelse(grepl("--", x), NA, x)
        x
      }
    )
  )
  return(x)
}


milc_dsrt <- cln_31(as.data.frame(t(apply(milc_dsrt, 1, cln_dupl))))



milc_pow_filter <- function(x){
  as.character(
    case_when(
      grepl('capture|pow|prison', x[[3]], ignore.case = T) ~ x[[4]],
      T ~ NA_character_
    )
  )
}


milc_pow <- cln_31(tibble(
  pow1 = milc_pow_filter(milc1),
  pow2 = milc_pow_filter(milc2),
  pow3 = milc_pow_filter(milc3),
  pow4 = milc_pow_filter(milc4),
  pow5 = milc_pow_filter(milc5)
))


milc_dth_filter <- function(x){
  as.character(
    case_when(
      grepl('died|death|kia|killed', x[[3]], ignore.case = T) ~ x[[4]],
      T ~ NA_character_
    )
  )
}

milc_death <- cln_31(tibble(
  dth1 = milc_dth_filter(milc1),
  dth2 = milc_dth_filter(milc2),
  dth3 = milc_dth_filter(milc3),
  dth4 = milc_dth_filter(milc4),
  dth5 = milc_dth_filter(milc5)
))

####### Step 3: add official discharges  ##########

dch <- all |>
  select(
    dschdt01, dschdt02, dschdt03, dschdt04, dschdt05,
    dschdt06, dschdt07, dschdt08, dschdt09, dschdt10,
    dschdt11, dschdt12, dschdt13, dschdt14, dschdt15,
    dschdt16, dschdt17, dschdt18, dschdt19, dschdt20,
    dchdt1_1, dchdt1_2, dchdt1_3, dchdt2_1, dchdt2_2, dchdt2_3
  )


dch <- cln_31(as.data.frame(t(apply(remove_blank(dch), 1, cln_dupl))))


####### Step 3: Combine rexit and lst  ##########

rlst <- bind_cols(
  all |> select(recidnum),
  lst,
  dch,
  milc_death,
  milc_dsrt,
  milc_pow
)


ind_timeline <- function(df, row_id) {
  row <- df[row_id, ]
  row <- row |> mutate(across(-recidnum, as.character))
  row_long <- row |>
    pivot_longer(
      -recidnum,
      names_to = "col",
      values_to = "date"
    ) |>
    mutate(date = suppressWarnings(as.Date(date, format = "%Y%m%d"))) |>
    filter(!is.na(date)) |>
    arrange(date)
  row_wide <- row_long |>
    select(recidnum, col, date) |>
    pivot_wider(names_from = col, values_from = date)
  
  row_wide
}




pow <- rlst |>
  filter(if_any(pow1:pow5, ~ !is.na(.)))

dsrt <- rlst |>
  filter(if_any(dsrt1:dsrtdt20, ~ !is.na(.)))


r <- ind_timeline(rlst, 10000)

pow1 <- ind_timeline(pow, 70)
pow2 <- ind_timeline(pow, 4)
pow3 <- ind_timeline(pow, 9)


####### Step 4: Create lst_tot and n_lst   ##########

#(If two enlistment dates with no discharge, count later date in n_lst, remove before lst_tot)

### n_lst: Isolate final enlistment dates, count number of non-blank columns per row

### lst_tot: Subtract each: dsch - lst, ignoring any lst in between. Add together numerical values into column





```

Now for hospital visits:

```{r hosp}

hosp <- all |>
  select(recidnum, 
    admtdt01, admtdt02, admtdt03, admtdt04, admtdt05, admtdt06, admtdt07, admtdt08, admtdt09, admtdt10, admtdt11, admtdt12, admtdt13, admtdt14, admtdt15, admtdt16, admtdt17, admtdt18, admtdt19, admtdt20,
relsdt01, relsdt02, relsdt03, relsdt04, relsdt05, relsdt06, relsdt07, relsdt08, relsdt09, relsdt10, relsdt11, relsdt12, relsdt13, relsdt14, relsdt15, relsdt16, relsdt17, relsdt18, relsdt19, relsdt20
  )

hosp <- remove_blank(hosp)


# Adding row for number of hospitalizations, deleting ambiguous dates

hosp <- hosp |> 
  mutate(n_hosp = rowSums(!is.na(across(admtdt01:admtdt20))),
         across(everything(), ~ifelse(grepl("--|##", .x), NA, .x))
  )
  
#Now to remove repeated dates

hosp <- as.data.frame(t(apply(remove_blank(hosp), 1, cln_dupl)))



```

## Recruit Buckets

To further analyze these recruits, we want to separate them into case archetypes:

-   TB to death

    -   Early diers (\<1 year)

    -   Moderate ()

    -   Resistant ()

-   Enlistment 1 to TB

-   Enlistment 1 to discharge final

\## a_brtcnt

\## a_clm[01-08]

\## a_clst[01,02,07]

\## afdesc[01,02,07]

\## dschrn[]

```{r buckets}

# TB to death

# When is the first mention of TB in their record? Isolate the variables that have TB data (connected to date).

## a_clm[01-05,07-08]        appdt[]
## a_clst[01,02,07]          ^
## afdesc[01,02,07]          infodt[]
## dschrn[01-05]             dschdt[]
## dschrn[07-14,16,19-20]    ^
## dthcs[01-10,12,16,18]     ?
## gen_rd_cause_6icd         ?
## g_rel[01,02,06,07]        x
## i_cmt2                    i_whn[]
## i_eff1[01-04,07]          ^
## i_eff201                  ^
## i_fev[1-2]                ^
## i_rel10[1-2]              ^
## ilwdsc[01-20]             admtdt[]
## l_rel01                   ? hosp?
## m_rel01                   ^
## n_rel01                   ^
## othrrn[01-02]             othrdt[]
## p_cmt[1-3,5]              ?
## pc_ds[1-3]                ?
## p_lrs[1-5,7]              ?
## p_rel[01-02]              ?
## q_rel01                   ?
## result[01-06,08,11]       x
## sc1rmks                   x
## sc2rmks                   x
## sc4rmk01                  x
## sc6rmk[01-05,08]          x
## unftc1_[1-3]              dchdt1_[1-3]
## unftc2_1                  dchdt2_1
## x_ext[11,21,41]           x


tb_date_date <- remove_blank(tb) |>
  select(recidnum,
    #a_clm01_date = appdt01,
    #a_clm02_date = appdt02,
    #a_clm03_date = appdt03,
    #a_clm04_date = appdt04,
    #a_clm05_date = appdt05,
    #a_clm07_date = appdt07,
    #a_clm08_date = appdt08,
    #a_clst01_date = appdt01,
    #a_clst02_date = appdt02,
    #a_clst07_date = appdt07,
    #afdesc01_date = infodt01,
    #afdesc02_date = infodt02,
    #afdesc07_date = infodt07,
    dschrn01_date = dschdt01,
dschrn02_date = dschdt02,
dschrn03_date = dschdt03,
dschrn04_date = dschdt04,
dschrn05_date = dschdt05,
dschrn07_date = dschdt07,
dschrn08_date = dschdt08,
dschrn09_date = dschdt09,
dschrn10_date = dschdt10,
dschrn11_date = dschdt11,
dschrn12_date = dschdt12,
dschrn13_date = dschdt13,
dschrn14_date = dschdt14,
dschrn16_date = dschdt16,
dschrn19_date = dschdt19,
dschrn20_date = dschdt20,
ilwdsc01_date = admtdt01,
ilwdsc02_date = admtdt02,
ilwdsc03_date = admtdt03,
ilwdsc04_date = admtdt04,
ilwdsc05_date = admtdt05,
ilwdsc06_date = admtdt06,
ilwdsc07_date = admtdt07,
ilwdsc08_date = admtdt08,
ilwdsc09_date = admtdt09,
ilwdsc10_date = admtdt10,
ilwdsc11_date = admtdt11,
ilwdsc12_date = admtdt12,
ilwdsc13_date = admtdt13,
ilwdsc14_date = admtdt14,
ilwdsc15_date = admtdt15,
ilwdsc16_date = admtdt16,
ilwdsc17_date = admtdt17,
ilwdsc18_date = admtdt18,
ilwdsc19_date = admtdt19,
ilwdsc20_date = admtdt20,
othrrn01_date = othrdt01,
othrrn02_date = othrdt02,
unftc1_1_date = dchdt1_1,
unftc1_2_date = dchdt1_2,
unftc1_3_date = dchdt1_3,
unftc2_1_date = dchdt2_1
  ) |>
  mutate(across(-recidnum, as.character))


tb_date_event <- remove_blank(tb) |>
  select(recidnum,
dschrn01,
dschrn02,
dschrn03,
dschrn04,
dschrn05,
dschrn07,
dschrn08,
dschrn09,
dschrn10,
dschrn11,
dschrn12,
dschrn13,
dschrn14,
dschrn16,
dschrn19,
dschrn20,

ilwdsc01,
ilwdsc02,
ilwdsc03,
ilwdsc04,
ilwdsc05,
ilwdsc06,
ilwdsc07,
ilwdsc08,
ilwdsc09,
ilwdsc10,
ilwdsc11,
ilwdsc12,
ilwdsc13,
ilwdsc14,
ilwdsc15,
ilwdsc16,
ilwdsc17,
ilwdsc18,
ilwdsc19,
ilwdsc20,

othrrn01,
othrrn02,

unftc1_1,
unftc1_2,
unftc1_3,
unftc2_1
  )



# Lengthen the dataset and identify pairs

event_long <- tb_date_event |>
  pivot_longer(
    cols = -recidnum,
    names_to = "slot",
    values_to = "event"
  )

date_long <- tb_date_date |>
  pivot_longer(
    cols = -recidnum,
    names_to = "slot",
    values_to = "date"
  ) |>
  mutate(slot = str_remove(slot, "_date$")) 

tb_long <- event_long |>
  inner_join(date_long, by = c("recidnum", "slot"))

tb_dates <- tb_long |>
  filter(
    !is.na(event),
    str_detect(event, regex("TUBER|CONSUMP|PHTH", ignore_case = TRUE))
  ) |>
  group_by(recidnum) |>
  summarise(
    tb_dates = list(date),
    .groups = "drop"
  )


###### And then join everything back to tb

tb_min_dates <- tb_dates |>
  mutate(
    tb_dates_clean = map(tb_dates, ~ .x[!is.na(.x) & .x != ""]),
    # Replace trailing "--" with "15"
    tb_dates_clean = map(tb_dates_clean, ~ str_replace(.x, "--$", "15")),
    # Keep only valid 8-digit dates
    tb_dates_clean = map(tb_dates_clean, ~ .x[str_detect(.x, "^\\d{8}$")]),
    # Get earliest date
    tb_first_date = map_chr(tb_dates_clean, ~ if(length(.x) == 0) NA_character_ else min(.x))
  ) |>
  select(recidnum, tb_first_date)

tb_full <- tb |>
  left_join(tb_min_dates, by = "recidnum") |>
  select(recidnum, tb_first_date)
```

\
